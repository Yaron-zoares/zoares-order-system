# 🗄️ מעבר למסד נתונים מרכזי - SQLite

## 📋 סקירה כללית

המערכת עברה ממסד נתונים מבוזר (קבצי JSON) למסד נתונים מרכזי (SQLite) כדי לפתור את בעיית הסנכרון בין מחשבים שונים.

## ✅ יתרונות המעבר

### 🔄 סנכרון מיידי
- **עדכון אוטומטי**: הזמנות חדשות נראות מיד למנהל
- **נתונים מסונכרנים**: אותו מידע נגיש לכל המחשבים
- **אין כפילויות**: כל הנתונים מרוכזים במקום אחד

### 🛡️ אבטחה ואמינות
- **גיבוי מרכזי**: קובץ מסד נתונים אחד לגיבוי
- **שלמות נתונים**: מניעת אובדן נתונים
- **גישה מבוקרת**: שליטה מלאה בנתונים

### ⚡ ביצועים
- **מהיר יותר**: SQLite מהיר יותר מקבצי JSON
- **חיפוש מתקדם**: שאילתות מורכבות
- **ניהול יעיל**: אינדקסים אוטומטיים

## 📁 מבנה מסד הנתונים

### טבלאות עיקריות:

1. **`orders`** - הזמנות פעילות
   - `id` - מזהה ייחודי
   - `customer_name` - שם הלקוח
   - `phone` - מספר טלפון
   - `address` - כתובת (JSON)
   - `items` - פריטי ההזמנה (JSON)
   - `status` - סטטוס ההזמנה
   - `created_at` - תאריך יצירה
   - `total_amount` - סכום כולל
   - `customer_id` - קישור ללקוח

2. **`closed_orders`** - הזמנות סגורות
   - אותן עמודות כמו orders
   - `closed_at` - תאריך סגירה

3. **`customers`** - לקוחות
   - `id` - מזהה ייחודי
   - `phone` - מספר טלפון (ייחודי)
   - `full_name` - שם מלא
   - `created_at` - תאריך יצירה
   - `total_orders` - כמות הזמנות
   - `total_spent` - סכום כולל
   - `last_order_date` - הזמנה אחרונה

4. **`order_counter`** - מונה הזמנות
   - `next_order_id` - מספר ההזמנה הבא

## 🔧 קבצים חדשים

### `database.py`
קובץ חדש המכיל את כל הפונקציות לניהול מסד הנתונים:

```python
# פונקציות עיקריות:
init_database()           # יצירת מסד הנתונים
load_orders()            # טעינת הזמנות
save_order()             # שמירת הזמנה
update_order()           # עדכון הזמנה
delete_order()           # מחיקת הזמנה
move_order_to_closed()   # העברה להזמנות סגורות
load_customers()         # טעינת לקוחות
find_or_create_customer() # יצירת/עדכון לקוח
update_customer_stats()  # עדכון סטטיסטיקות
cleanup_old_orders()     # ניקוי הזמנות ישנות
cleanup_old_customers()  # ניקוי לקוחות ישנים
import_existing_data()   # ייבוא נתונים קיימים
```

## 📊 ייבוא נתונים קיימים

המערכת מייבאת אוטומטית את כל הנתונים הקיימים מקבצי JSON:

- `orders.json` → טבלת `orders`
- `closed_orders.json` → טבלת `closed_orders`
- `customers.json` → טבלת `customers`

**הערה**: קבצי JSON המקוריים נשמרים כגיבוי.

## 🚀 הפעלה

### הפעלה ראשונה:
```bash
# המערכת תיצור אוטומטית את מסד הנתונים ותייבא נתונים קיימים
python -m streamlit run app.py
python -m streamlit run customer_app.py --server.port 8505
```

### קבצים שנוצרים:
- `zoares_central.db` - מסד הנתונים המרכזי
- `zoares_central.db-journal` - קובץ זמני של SQLite

## 🔄 שינויים בקוד

### `customer_app.py`:
- הוספת ייבוא מ-`database`
- החלפת `save_order()` ב-`save_order_with_customer()`
- הסרת פונקציות JSON ישנות

### `app.py`:
- הוספת ייבוא מ-`database`
- החלפת כל הפונקציות הישנות
- עדכון קריאות למסד הנתונים

## 📈 ביצועים

### לפני המעבר:
- ❌ נתונים מבוזרים
- ❌ סנכרון ידני
- ❌ כפילויות נתונים
- ❌ אובדן נתונים אפשרי

### אחרי המעבר:
- ✅ נתונים מרוכזים
- ✅ סנכרון אוטומטי
- ✅ נתונים ייחודיים
- ✅ שלמות נתונים

## 🛠️ תחזוקה

### גיבוי:
```bash
# גיבוי מסד הנתונים
cp zoares_central.db backup_$(date +%Y%m%d_%H%M%S).db
```

### ניקוי:
```python
# ניקוי אוטומטי מתבצע בכל הפעלה
cleanup_old_orders()     # הזמנות ישנות
cleanup_old_customers()  # לקוחות ישנים
```

### עדכון:
```python
# עדכון סטטיסטיקות לקוח
update_customer_stats(customer_id, order_total)
```

## 🔍 פתרון בעיות

### שגיאה: "database is locked"
- סגור את כל האפליקציות
- מחק את הקובץ `zoares_central.db-journal`
- הפעל מחדש

### שגיאה: "table already exists"
- מחק את הקובץ `zoares_central.db`
- הפעל מחדש (ייווצר אוטומטית)

### נתונים חסרים:
- בדוק שקובץ `zoares_central.db` קיים
- הפעל `import_existing_data()` ידנית

## 📞 תמיכה

לכל שאלה או בעיה:
1. בדוק את קובץ `zoares_central.db`
2. בדוק את הלוגים של Streamlit
3. פנה לתמיכה טכנית

---

**הערה**: המעבר למסד נתונים מרכזי מבטיח סנכרון מלא בין כל המחשבים במערכת!
