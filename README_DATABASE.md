# 🗄️ מסד הנתונים - מערכת זוארס

## 🚀 הפעלת המערכת

### **פורטים מומלצים:**
- **אפליקציה ראשית**: פורט 9001
- **אפליקציית לקוחות**: פורט 9002  
- **שרת API**: פורט 8001

### **פקודות הפעלה:**
```bash
# 1. הפעלת שרת ה-API
cd backend
python api.py

# 2. הפעלת האפליקציה הראשית
streamlit run app.py --server.port 9001

# 3. הפעלת אפליקציית הלקוחות
streamlit run customer_app.py --server.port 9002
```

## 📊 מבנה מסד הנתונים

### **טבלאות עיקריות:**

#### **orders** - הזמנות פעילות
- `id` - מזהה ייחודי (INTEGER PRIMARY KEY)
- `customer_name` - שם הלקוח
- `phone` - מספר טלפון
- `address` - כתובת (JSON)
- `delivery_notes` - הערות למשלוח
- `butcher_notes` - הערות לקצב
- `items` - פריטי ההזמנה (JSON)
- `status` - סטטוס ההזמנה
- `created_at` - תאריך יצירה
- `total_amount` - סכום כולל
- `customer_id` - מזהה לקוח

#### **closed_orders** - הזמנות סגורות
- מבנה זהה ל-orders + `closed_at` - תאריך סגירה

#### **customers** - לקוחות
- `id` - מזהה ייחודי
- `phone` - מספר טלפון (UNIQUE)
- `full_name` - שם מלא
- `created_at` - תאריך יצירה
- `last_updated` - עדכון אחרון
- `total_orders` - כמות הזמנות
- `total_spent` - סכום כולל שהוצא
- `last_order_date` - תאריך הזמנה אחרון

#### **order_counter** - מונה הזמנות
- `id` - מזהה (תמיד 1)
- `next_order_id` - מספר ההזמנה הבא

## 🔧 פונקציות תחזוקה

### **פונקציות זמינות:**
```python
from database import (
    init_database,           # אתחול מסד הנתונים
    reset_order_counter,      # איפוס מונה הזמנות
    fix_order_id_conflicts,   # תיקון קונפליקטים
    cleanup_old_orders,       # ניקוי הזמנות ישנות
    cleanup_old_customers     # ניקוי לקוחות ישנים
)
```

### **דף תחזוקה:**
המערכת כוללת דף תחזוקה אוטומטי ב:
- עבור לדף "תחזוקת מסד הנתונים"
- בדוק קונפליקטים
- אפס מונה הזמנות
- נקה הזמנות ישנות

## 🚨 פתרון בעיות נפוצות

### **שגיאת UNIQUE constraint:**
```python
# הפונקציה save_order מטפלת בזה אוטומטית
# אם יש בעיה, השתמש ב:
fix_order_id_conflicts()
reset_order_counter()
```

### **מסד נתונים נעול:**
```python
# הפונקציות כוללות טיפול אוטומטי
# אם יש בעיה מתמשכת:
# 1. סגור את כל האפליקציות
# 2. מחק את קובץ .db-journal אם קיים
# 3. הפעל מחדש
```

### **בעיות פורטים:**
אם הפורטים תפוסים, השתמש בפורטים גבוהים יותר:
```bash
streamlit run app.py --server.port 9003
streamlit run customer_app.py --server.port 9004
```

## 📈 ניהול נתונים

### **זמני שמירה:**
- **הזמנות פעילות**: 20 ימי עסקים
- **הזמנות סגורות**: 5 שנים (1825 ימים)
- **לקוחות**: 365 ימים

### **ניקוי אוטומטי:**
המערכת מנקה נתונים ישנים אוטומטית:
- הזמנות פעילות ישנות מועברות לסגורות
- הזמנות סגורות ישנות נמחקות
- לקוחות ללא הזמנות נמחקים

## 🔄 סנכרון נתונים

### **מצב online:**
- נתונים נשמרים בשרת ה-API
- סנכרון אוטומטי עם מסד הנתונים המקומי
- עדכונים בזמן אמת

### **מצב offline:**
- נתונים נשמרים מקומית
- סנכרון אוטומטי כשהשרת זמין שוב
- אין אובדן נתונים

## 📁 קבצי מסד הנתונים

### **קבצים עיקריים:**
- `zoares_central.db` - מסד הנתונים הראשי
- `database.py` - פונקציות ניהול
- `backend/database.py` - מסד נתונים לשרת ה-API

### **גיבוי:**
- מסד הנתונים מגובה אוטומטית
- קבצי .db-journal נוצרים אוטומטית
- שמירת נתונים ב-JSON (ייבוא/ייצוא)

## 🛠️ כלי ניהול

### **DB Browser for SQLite:**
- צפייה בנתונים
- עריכת נתונים ידנית
- ייצוא/ייבוא נתונים
- ניתוח מבנה הטבלאות

### **פקודות בדיקה:**
```bash
# בדיקת מסד הנתונים
python -c "from database import init_database; init_database(); print('✅ מסד הנתונים אותחל')"

# בדיקת API Client
python -c "from backend.client import ZoaresAPIClient; print('✅ API Client נטען')"
```

---

**גרסה**: 2.0  
**עדכון אחרון**: אוגוסט 2024  
**מפתח**: מערכת זוארס
